<!DOCTYPE html>
<html>
<head>
  <title>Chat Room</title>
</head>
<body>

<h2>Chat App</h2>

<button onclick="logout()">Logout</button>

<br><br>

<input id="room" placeholder="Room">
<button onclick="joinRoom()">Join Room</button>
<button onclick="leaveRoom()">Leave Room</button>

<div id="chat"></div>

<br>

<input id="message" placeholder="Message">
<button onclick="sendMessage()">Send</button>

<p id="typing"></p>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const username = localStorage.getItem("username");

  if (!username) {
    window.location.href = "login.html";
  }

  function logout() {
    localStorage.removeItem("username");
    window.location.href = "login.html";
  }

  function joinRoom() {
    const room = document.getElementById("room").value;
    socket.emit("joinRoom", room);
  }

  function leaveRoom() {
    const room = document.getElementById("room").value;
    socket.emit("leaveRoom", room);
  }

  function sendMessage() {
    const room = document.getElementById("room").value;
    const message = document.getElementById("message").value;

    socket.emit("sendMessage", {
      room,
      username,
      message
    });

    document.getElementById("message").value = "";
  }

  socket.on("loadMessages", (messages) => {
  const chat = document.getElementById("chat");
  chat.innerHTML = "";

  messages.forEach(msg => {
    chat.innerHTML += `<p><strong>${msg.from_user}:</strong> ${msg.message}</p>`;
  });
});

  socket.on("receiveMessage", (data) => {
    const chat = document.getElementById("chat");
    chat.innerHTML += `<p><strong>${data.username}:</strong> ${data.message}</p>`;
  });

  document.getElementById("message").addEventListener("input", () => {
    const room = document.getElementById("room").value;
    socket.emit("typing", { room, username });
  });

  let typingTimeout;

  socket.on("userTyping", (user) => {
    const typing = document.getElementById("typing");
    typing.innerText = user + " is typing...";
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      typing.innerText = "";
    }, 3000);
  });

  socket.on("userLeft", (msg) => {
    const chat = document.getElementById("chat");
    chat.innerHTML += `<p><em>${msg}</em></p>`;
  });

</script>

</body>
</html>
